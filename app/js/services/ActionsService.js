angular.module('AgaveToGo',[]).service('ActionsService',['$uibModal', '$rootScope', '$localStorage', '$location', '$state', '$stateParams', 'AppsController', 'SystemsController', 'JobsController', 'NotificationsController', 'MetaController', 'MonitorsController', function($uibModal, $rootScope, $localStorage, $location, $state, $stateParams, AppsController, SystemsController, JobsController, NotificationsController, MetaController, MonitorsController){  this.getNotifications = function(resourceType, resource){    switch(resourceType){      case 'monitor':        $state.go('notifications-manager', {'associatedUuid': resource.id, 'resourceType': resourceType});        break;      default:        $state.go('notifications-manager', {'associatedUuid': resource.uuid, 'resourceType': resourceType});        break;    }  };  this.clone = function(resourceType, resource, resourceAction, resourceList, resourceIndex){    switch(resourceType){      case 'systems':        SystemsController.getSystemRole(resource.id, $localStorage.activeProfile.username)          .then(function(response){            if (response.result.role !== "NONE" && response.result.role !== 'GUEST'){              var modalInstance = $uibModal.open({              templateUrl: 'tpl/modals/ModalConfirmCloneAction.html',              scope: $rootScope,              resolve:{                  resource: function() {                    return resource;                  },                  resourceType: function() {                    return resourceType;                  },                  resourceAction: function() {                    return resourceAction;                  },                  resourceList: function(){                    return resourceList;                  },                  resourceIndex: function(){                    return resourceIndex;                  }              },              controller: ['$scope', '$modalInstance', 'resourceType', 'resource', 'resourceAction', 'resourceList', 'resourceIndex',                function($scope, $modalInstance, resourceType, resource, resourceAction, resourceList, resourceIndex ){                    $scope.resource = resource;                    $scope.resourceAction = resourceAction;                    $scope.schema = {                      "type": "object",                      "title": "Interactive registration form for DesignSafe Application",                      "properties": {                        "id": {                          "type": "string",                          "description": "A new unique identifier you assign to the system. A system id must be globally unique across a tenant and cannot be reused once deleted",                          "title": "ID",                        }                      }                    };                    $scope.form = [                       {                         "key": "id",                         ngModelOptions: {                           updateOnDefault: true                         },                         $validators: {                            required: function(value) {                              return value ? true : false;                            }                          },                          validationMessage: {                            "required": "Missing required"                          }                        }                    ];                    $scope.model= {};                    $scope.cancel = function(){                        $modalInstance.dismiss('cancel');                    };                    $scope.submit = function(){                      $scope.requesting = true;                      $scope.error = '';                      if ($scope.myForm.$valid){                        var body = {'action': resourceAction, 'id': $scope.model.id};                        SystemsController.updateInvokeSystemAction(body, resource.id)                        .then(                          function(response){                            App.alert({message: "Successfully cloned " + resource.id});                            $modalInstance.dismiss();                            $scope.requesting = false;                            $state.transitionTo($state.current, $stateParams, {                              reload: true, inherit: false, notify: true                            });                          },                          function(response){                            var message = '';                            if (response.errorResponse){                              if (response.errorResponse.message) {                                message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                              } else if (response.errorResponse.fault){                                message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                              }                            } else {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id;                            }                            $scope.error = message;                            $scope.requesting = false;                          });                      } else {                        var message = 'Invalid form';                        App.alert(                          {                            type: 'danger',                            message: message                          }                        );                        $scope.requesting = false;                      }                    }                  }]              });            } else {              App.alert({type: 'danger',message: 'Missing credentials to clone system'});            }          })          .catch(function(response) {            var message = '';            if (response.errorResponse){              if (response.errorResponse.message) {                message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message              } else if (response.errorResponse.fault){                message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;              }            } else {              message = 'Error trying to ' + resourceAction + ' ' + resource.id;            }            App.alert(              {                type: 'danger',                message: message              }            );          });    }  };  this.confirmAction = function(resourceType, resource, resourceAction, resourceList, resourceIndex){      var modalInstance = $uibModal.open({        templateUrl: 'tpl/modals/ModalConfirmResourceAction.html',        scope: $rootScope,        resolve:{            resource: function() {              return resource;            },            resourceType: function() {              return resourceType;            },            resourceAction: function() {              return resourceAction;            },            resourceList: function(){              return resourceList;            },            resourceIndex: function(){              return resourceIndex;            }        },        controller: ['$scope', '$modalInstance', 'resourceType', 'resource', 'resourceAction', 'resourceList', 'resourceIndex',          function($scope, $modalInstance, resourceType, resource, resourceAction, resourceList, resourceIndex ){            $scope.resourceType = resourceType;            $scope.resource = resource;            $scope.resourceAction = resourceAction;            $scope.resourceIndex = resourceIndex;            $scope.resourceList = resourceList;            $scope.ok = function(){              switch(resourceType){                case 'apps':                  switch(resourceAction){                    case 'enable':                    case 'disable':                    case 'publish':                    case 'unpublish':                      var body = {'action': resourceAction};                      AppsController.updateInvokeAppAction(resource.id, body)                        .then(                          function(response){                            angular.copy(response.result, resource);                            // $scope.$apply();                            $modalInstance.dismiss();                          },                          function(response){                            var message = '';                            if (response.errorResponse.message) {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                            } else if (response.errorResponse.fault){                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                            } else {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id;                            }                            App.alert(                              {                                type: 'danger',                                message: message                              }                            );                            $modalInstance.dismiss();                          });                      break;                    case 'delete':                    AppsController.deleteApp(resource.id)                      .then(                        function(response){                          if (typeof resourceList === 'undefined' || resourceList === ''){                            $location.path('/apps');                          } else {                            $scope.resourceList.splice($scope.resourceList.indexOf($scope.resource), 1);                          }                          $modalInstance.dismiss();                        },                        function(response){                          var message = '';                          if (response.errorResponse.message) {                            message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                          } else if (response.errorResponse.fault){                            message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                          } else {                            message = 'Error trying to ' + resourceAction + ' ' + resource.id;                          }                          App.alert(                            {                              type: 'danger',                              message: message                            }                          );                          $modalInstance.dismiss();                        });                      break;                  }                  break;                case 'systems':                  switch(resourceAction){                    case 'enable':                    case 'disable':                    case 'publish':                    case 'unpublish':                      var body = {'action': resourceAction};                      SystemsController.updateInvokeSystemAction(body, resource.id)                        .then(                          function(response){                            angular.copy(response, resource);                            $scope.$apply();                            $modalInstance.dismiss();                          },                          function(response){                            var message = '';                            if (response.errorResponse.message) {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                            } else if (response.errorResponse.fault){                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                            } else {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id;                            }                            App.alert(                              {                                type: 'danger',                                message: message                              }                            );                            $modalInstance.dismiss();                          });                      break;                    case 'delete':                      SystemsController.deleteSystem(resource.id)                        .then(                          function(response){                            if (typeof resourceList === 'undefined' || resourceList === ''){                              $location.path('/systems');                            } else {                              $scope.resourceList.splice($scope.resourceList.indexOf($scope.resource), 1);                            }                            $modalInstance.dismiss();                          },                          function(response){                            var message = '';                            if (response.errorResponse.message) {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                            } else if (response.errorResponse.fault){                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                            } else {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id;                            }                            App.alert(                              {                                type: 'danger',                                message: message                              }                            );                            $modalInstance.dismiss();                          });                          break;                  }                  break;                  case 'jobs':                    switch(resourceAction){                      case 'delete':                        JobsController.deleteJob(resource.id)                          .then(                            function(response){                              if (typeof resourceList === 'undefined' || resourceList === ''){                                $location.path('/jobs');                              } else {                                // var removeIndex = _.findIndex($scope.resourceList, function(res){                                //   return res.id === resource.id;                                // });                                // $scope.resourceList.splice(removeIndex, 1);                                $scope.resourceList.splice($scope.resourceList.indexOf($scope.resource), 1);                              }                              $modalInstance.dismiss();                            },                            function(response){                              var message = '';                              if (response.errorResponse.message) {                                message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                              } else if (response.errorResponse.fault){                                message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                              } else {                                message = 'Error trying to ' + resourceAction + ' ' + resource.id;                              }                              App.alert(                                {                                  type: 'danger',                                  message: message                                }                              );                              $modalInstance.dismiss();                            }                          );                        break;                        case 'stop':                          var body = {action: resourceAction};                          JobsController.createStopJob(body, resource.id)                            .then(                              function(response){                                resource.status = 'STOPPED';                                $modalInstance.dismiss();                              },                              function(response){                                var message = '';                                if (response.errorResponse.message) {                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                                } else if (response.errorResponse.fault){                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                                } else {                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id;                                }                                App.alert(                                  {                                    type: 'danger',                                    message: message                                  }                                );                                $modalInstance.dismiss();                              }                            );                          break;                    }                  break;                  case 'notifications':                    switch(resourceAction){                      case 'delete':                      NotificationsController.deleteNotification(resource.id)                        .then(                          function(response){                            if (typeof resourceList === 'undefined' || resourceList === ''){                              $location.path('/notifications');                            } else {                              $scope.resourceList.splice($scope.resourceList.indexOf($scope.resource), 1);                            }                            $modalInstance.dismiss();                          },                          function(response){                            var message = '';                            if (response.errorResponse.message) {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                            } else if (response.errorResponse.fault){                              message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                            } else {                              message = 'Error trying to ' + resourceAction + ' ' + resource.id;                            }                            App.alert(                              {                                type: 'danger',                                message: message                              }                            );                            $modalInstance.dismiss();                          }                        );                        break;                    }                    break;                    case 'meta':                      switch(resourceAction){                        case 'delete':                          MetaController.deleteMetadata(resource.id)                            .then(                              function(response){                                if (typeof resourceList === 'undefined' || resourceList === ''){                                  $location.path('/notifications/alerts');                                } else {                                  $scope.resourceList.splice($scope.resourceList.indexOf($scope.resource), 1);                                }                                $modalInstance.dismiss();                              },                              function(response){                                var message = '';                                if (response.errorResponse.message) {                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                                } else if (response.errorResponse.fault){                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                                } else {                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id;                                }                                App.alert(                                  {                                    type: 'danger',                                    message: message                                  }                                );                              }                            );                          break;                      }                    break;                    case 'monitors':                      switch(resourceAction){                        case 'delete':                          MonitorsController.deleteMonitoringTask(resource.id)                            .then(                              function(response){                                if (typeof resourceList === 'undefined' || resourceList === ''){                                  $location.path('/monitors/manager');                                } else {                                  $scope.resourceList.splice($scope.resourceList.indexOf($scope.resource), 1);                                }                                $modalInstance.dismiss();                              },                              function(response){                                var message = '';                                if (response.errorResponse.message) {                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.message                                } else if (response.errorResponse.fault){                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id + ' - ' + response.errorResponse.fault.message;                                } else {                                  message = 'Error trying to ' + resourceAction + ' ' + resource.id;                                }                                App.alert(                                  {                                    type: 'danger',                                    message: message                                  }                                );                              }                            );                          break;                      }                    break;              }            };            $scope.cancel = function(){                $modalInstance.dismiss('cancel');            };        }]      });  };  this.edit = function(resourceType, resource){    switch(resourceType){      case 'apps': $state.go('apps-edit', {'appId': resource.id });        break;      case 'systems': $state.go('systems-edit', {'systemId': resource.id });        break;      case 'monitors':        $state.go('monitors-edit', {'monitorId': resource.id });        break;      case 'notifications':        $state.go('notifications-edit', {'notificationId': resource.id });        break;    }  };}]);