angular.module('AgaveToGo').controller('AppDirectoryController', function ($injector, $timeout, $rootScope, $scope, $state, $stateParams, $q, $uibModal, $http, $translate, Commons, AppsController, SystemsController, ActionsService, PermissionsService, MessageService) {    $scope.offset = $scope.offset || 0;    $scope.limit = $scope.limit || 25;    $scope.systems = [];    $scope._COLLECTION_NAME = $scope._COLLECTION_NAME || 'apps';    $scope._RESOURCE_NAME = $scope._RESOURCE_NAME || 'app';    $scope.limit = 10;    $scope.available = true;    $scope.publicOnly = null;    $scope.privateOnly = null;    $scope.sortType = 'lastModified';    $scope.sortReverse  = true;    $scope.appsList = [];    $scope.appsDetailsList = [];    $scope.filter = '';    $scope.query = '';    $scope.getAppDetails = function(id, callback) {      return AppsController.getAppDetails(id).then(        function(response){          return callback(response.result);        }      );    };    $scope.refresh = function() {        $scope.appsList = [];        $scope.appsDetailsList = [];        $scope.requesting = true;        SystemsController.listSystems(99999).then(            function (response) {              $scope.systems = response;              AppsController.searchApps(                $scope.query              )                .then(                  function(response){                    $scope.totalItems = response.result.length;                    $scope[$scope._COLLECTION_NAME] = [];                    var prom = [];                    response.result.forEach(function (app, i) {                        prom.push($scope.getAppDetails(app.id, function(value){                          $scope[$scope._COLLECTION_NAME].push(value);                        }));                    });                    $q.all(prom).then(                      function (response) {                        $scope.requesting = false;                      },                      function(response){                        MessageService.handle(response, $translate.instant('error_apps_search'));                      }                    );                  }, function(response){                    MessageService.handle(response, $translate.instant('error_apps_search'));                    $scope.requesting = false;                  }                );            },            function(response){              MessageService.handle(response, $translate.instant('error_apps_search'));              $scope.requesting = false;            }        );    };    $scope.refresh();    $scope.searchTools = function(query){      $scope.query = query;      $scope.refresh();    }    $scope.confirmAction = function(resourceType, resource, resourceAction, resourceList, resourceIndex){        ActionsService.confirmAction(resourceType, resource, resourceAction, resourceList, resourceIndex);    }    $scope.edit = function(resourceType, resource){      ActionsService.edit(resourceType, resource);    };    $scope.editPermissions = function(resource) {        PermissionsService.editPermissions(resource);    }    $scope.getNotifications = function(resourceType, resource){      ActionsService.getNotifications(resourceType, resource);    };    $scope.getSystemName = function(id) {      if (id) {          for(var i=0; i<$scope.systems.length; i++) {              if ($scope.systems[i].id === id) {                  return $scope.systems[i].name;              }          }      }      return id;    };});